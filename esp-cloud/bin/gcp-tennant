#!/bin/bash
#  Copyright Â© 2019, SAS Institute Inc., Cary, NC, USA.  All Rights Reserved.
#  SPDX-License-Identifier: Apache-2.0

ROOT=`dirname $0`
ROOT=`readlink -f $ROOT`

# usage
#
show_usage() {
    echo "Usage: $0"
    echo ""
    echo "required: -p <GCP project> -t <tennant name>"
    echo "          -c <GKE cluster name>"
    echo ""
    exit 1
}

while getopts "?c:t:p:" opt; do
    case "$opt" in
        \?)
            show_usage
            return 1
            ;;
        c)  GCP_CL=$OPTARG
            ;;
        t)  GCP_NS=$OPTARG
            ;;
        p)  GCP_PR=$OPTARG
            ;;
        *)
            echo "bad option <$opt>" && show_usage
    esac
done

[ -z $GCP_CL ]       && echo "cluster name must be specified" && show_usage
[ -z $GCP_NS ]       && echo "K8 namespace must be specified" && show_usage
[ -z $GCP_PR ]       && echo "GCP project must be specified"  && show_usage

gcloud organizations list &> /dev/null ; [ 0 -ne $? ] && echo "not logged in to GCP" && exit 1


echo "creating K8 namespace"
kubectl get ns/$GCP_NS &> /dev/null
[ 0 -ne $? ] && kubectl create ns $GCP_NS

GCP_IP=$(kubectl -n ingress-nginx get svc/ingress-nginx-controller -o json | jq .status.loadBalancer.ingress[0].ip)
GCP_IP=$(eval echo $GCP_IP)
while [ "null" == "$GCP_IP" ]; do
    echo "sleeping 1 second" ; sleep 1
    GCP_IP=$(kubectl -n ingress-nginx get svc/ingress-nginx-controller -o json | jq .status.loadBalancer.ingress[0].ip)
    GCP_IP=$(eval echo $GCP_IP)
done

GCP_DM=$(gcloud dns managed-zones describe ${GCP_CL}-zone | fgrep dnsName: | cut -f 2 -d ' ')
GCP_DM=${GCP_DM%%.}

# add zone to private DNS
#
gcloud dns --project=${GCP_PR} record-sets transaction start --zone=${GCP_CL}-zone
gcloud dns --project=${GCP_PR} record-sets transaction add ${GCP_IP} --name=${GCP_NS}.${GCP_DM}. --ttl=300 --type=A --zone=${GCP_CL}-zone
gcloud dns --project=${GCP_PR} record-sets transaction execute --zone=${GCP_CL}-zone

echo ""
echo ""
echo "Created kubernetes namespace, private DNS record"
echo ""
echo "You must add an alias record to DNS that points"
echo ""
echo "   ${GCP_NS}.${GCP_DM}  --> ${GCP_IP}"
echo ""
echo "cluster namespace: $GCP_NS"
echo ""
